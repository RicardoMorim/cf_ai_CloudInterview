@startuml
!theme vibrant
title CloudInterview - Class Diagram (Updated Architecture)

package "Frontend Layer" {
  class InterviewPage {
    -sessionId: string
    -currentQuestion: InterviewQuestion
    -answers: InterviewAnswer[]
    +startInterview()
    +submitAnswer()
    +nextQuestion()
    +endInterview()
  }
  
  class CodeEditor {
    -code: string
    -language: ProgrammingLanguage
    -theme: string
    +executeCode()
    +formatCode()
    +resetCode()
  }
  
  class VoiceInterface {
    -isRecording: boolean
    -audioBlob: Blob
    +startRecording()
    +stopRecording()
    +transcribeAudio()
  }
}

package "Backend - Cloudflare Worker" {
  class HonoRouter {
    +POST /api/sessions
    +GET /api/sessions/:id/question/next
    +POST /api/sessions/:id/answer
    +POST /api/sessions/:id/chat
    +POST /api/sessions/:id/end
  }
  
  package "Middleware" {
    class CorsMiddleware {
      +handle(request, next)
    }
    
    class ErrorHandler {
      +handle(error, context)
    }
    
    class AppError {
      +statusCode: number
      +code: string
      +message: string
      +details?: string
    }
  }
}

package "Services Layer" {
  package "AI Services" {
    class AIInterviewer {
      -AI: WorkersAI
      +generateOpeningIntroduction()
      +generateClosingRemarks()
      +generateQuestionPrompt()
    }
    
    class AIEvaluator {
      -AI: WorkersAI
      +evaluateCodeSubmission()
      +conductBehavioralEvaluation()
      +analyzeSentiment()
    }
    
    class AIGenerator {
      -AI: WorkersAI
      +generateResponse()
      +generateHint()
      +generateScenarioQuestion()
    }
  }
  
  package "Question Services" {
    class QuestionSelector {
      -env: Env
      +selectTechnicalQuestions()
      +selectBehavioralQuestions()
      -selectQuestionsWithAI()
      -parseAIQuestionResponse()
      -fallbackRandomSelection()
    }
  }
  
  package "Session Services" {
    class SessionStateManager {
      +updateStatus()
      +addAnswer()
      +getCurrentQuestion()
      +addAIResponse()
      +updateDuration()
    }
    
    class SessionActions {
      +submitAnswer()
      +nextQuestion()
      +generateFinalFeedback()
      +completeSession()
      +processChatMessage()
      +buildTranscript()
    }
  }
}

package "Durable Objects" {
  class InterviewSessionDO {
    -state: DurableObjectState
    -env: Env
    -session: InterviewSession
    +startSession()
    +getCurrentQuestion()
    +submitAnswer()
    +nextQuestion()
    +completeSession()
    +processChatMessage()
    +getTranscript()
    -loadSession()
    -saveSession()
    -setupSessionCleanup()
  }
}

package "Data Models" {
  class InterviewSession {
    +sessionId: string
    +userId: string
    +mode: InterviewMode
    +status: InterviewStatus
    +questions: InterviewQuestion[]
    +answers: InterviewAnswer[]
    +aiResponses: AIResponse[]
    +feedback?: InterviewFeedback
    +currentQuestionIndex: number
  }
  
  class InterviewQuestion {
    +questionId: string
    +type: QuestionType
    +title: string
    +text: string
    +difficulty: Difficulty
    +hints: string[]
    +tags: string[]
  }
  
  class InterviewAnswer {
    +questionId: string
    +answerText: string
    +code?: string
    +language?: ProgrammingLanguage
    +submittedAt: string
    +evaluation?: Evaluation
  }
  
  class AIResponse {
    +responseId: string
    +type: AIResponseType
    +content: string
    +sentiment: Sentiment
    +confidence: number
    +followUp: boolean
  }
}

package "Cloudflare Infrastructure" {
  class WorkersAI {
    +run(model, params)
  }
  
  class KVNamespace {
    +get(key, options)
    +put(key, value)
  }
  
  class DurableObjectState {
    +storage: DurableObjectStorage
    +id: DurableObjectId
  }
}

' Relationships
InterviewPage --> HonoRouter : HTTP Requests
InterviewPage *-- CodeEditor
InterviewPage *-- VoiceInterface

HonoRouter --> CorsMiddleware
HonoRouter --> ErrorHandler
HonoRouter --> InterviewSessionDO

InterviewSessionDO --> QuestionSelector : uses
InterviewSessionDO --> SessionActions : delegates
InterviewSessionDO --> SessionStateManager : uses
InterviewSessionDO *-- InterviewSession

QuestionSelector --> WorkersAI : uses
QuestionSelector --> KVNamespace : reads

AIEvaluator --> WorkersAI : uses
AIInterviewer --> WorkersAI : uses
AIGenerator --> WorkersAI : uses

SessionActions --> AIInterviewer : uses
SessionActions --> AIEvaluator : uses
SessionActions --> AIGenerator : uses

InterviewSession *-- InterviewQuestion
InterviewSession *-- InterviewAnswer
InterviewSession *-- AIResponse

SessionStateManager ..> InterviewSession : modifies

@enduml
